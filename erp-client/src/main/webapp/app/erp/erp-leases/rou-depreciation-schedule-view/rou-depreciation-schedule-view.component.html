<div class="container-fluid py-3">
  <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-3">
    <div>
      <h3 class="mb-0">ROU Depreciation Schedule</h3>
      <small class="text-muted">Amortisation by lease period for the selected contract</small>
    </div>
    <div class="d-flex flex-wrap gap-3 align-items-center justify-content-end flex-grow-1" style="min-width: 280px;">
      <div class="flex-grow-1" style="min-width: 280px; max-width: 360px;">
        <jhi-m21-ifrs16-lease-form-control
          inputControlLabel="Lease contract (search to select)"
          [inputValue]="selectedContract"
          (valueSelected)="onContractSelected($event)"
        >
          <option [ngValue]="selectedContract"></option>
        </jhi-m21-ifrs16-lease-form-control>
      </div>
      <div class="d-flex align-items-center gap-2" style="min-width: 220px;">
        <label for="asAtDate" class="text-muted small mb-0">As at date</label>
        <input
          id="asAtDate"
          class="form-control form-control-sm"
          type="date"
          [ngModel]="asAtDateInput"
          (ngModelChange)="onAsAtDateChange($event)"
        />
      </div>
    </div>
  </div>

  <div *ngIf="loadError" class="alert alert-danger" role="alert">
    {{ loadError }}
  </div>

  <div *ngIf="loading" class="alert alert-info" role="status">Loading depreciation schedule…</div>

  <div *ngIf="!loading && scheduleRows.length === 0" class="alert alert-secondary" role="alert">
    Select a lease contract to view its depreciation schedule.
  </div>

  <div *ngIf="scheduleRows.length > 0" class="row g-3 mb-3">
    <div class="col-md-3">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="text-muted text-uppercase small">Initial ROU amount</div>
          <div class="display-6">{{ initialAmount | number: '1.2-2' }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="text-muted text-uppercase small">Total depreciation</div>
          <div class="display-6">{{ totalDepreciation | number: '1.2-2' }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="text-muted text-uppercase small">Closing net book value</div>
          <div class="display-6">{{ closingBalance | number: '1.2-2' }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <div class="text-muted text-uppercase small">Current period depreciation</div>
          <div class="display-6">{{ currentPeriodDepreciation | number: '1.2-2' }}</div>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="scheduleRows.length > 0" class="d-flex align-items-center justify-content-between mb-2">
    <div class="text-muted small">Export depreciation rows</div>
    <div class="btn-group" role="group" aria-label="Export depreciation schedule">
      <button type="button" class="btn btn-outline-primary btn-sm" (click)="exportToCsv()" [disabled]="exportingCsv || exportingExcel">
        <span *ngIf="exportingCsv" class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
        Export CSV
      </button>
      <button type="button" class="btn btn-outline-success btn-sm" (click)="exportToExcel()" [disabled]="exportingCsv || exportingExcel">
        <span *ngIf="exportingExcel" class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
        Export Excel
      </button>
    </div>
  </div>

  <div *ngIf="exportError" class="alert alert-warning" role="alert">{{ exportError }}</div>

  <div class="table-responsive" *ngIf="scheduleRows.length > 0">
    <table class="table table-sm align-middle table-striped">
      <thead class="table-light">
        <tr>
          <th scope="col">#</th>
          <th scope="col">Period</th>
          <th scope="col">Start date</th>
          <th scope="col">End date</th>
          <th scope="col" class="text-end">Initial amount</th>
          <th scope="col" class="text-end">Depreciation</th>
          <th scope="col" class="text-end">Outstanding</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let row of scheduleRows; trackBy: trackRowById">
          <td>{{ row.sequenceNumber ?? '-' }}</td>
          <td>{{ row.periodCode || '—' }}</td>
          <td>{{ formatDate(row.periodStartDate) }}</td>
          <td>{{ formatDate(row.periodEndDate) }}</td>
          <td class="text-end">{{ row.initialAmount | number: '1.2-2' }}</td>
          <td class="text-end">{{ row.depreciationAmount | number: '1.2-2' }}</td>
          <td class="text-end">{{ row.outstandingAmount | number: '1.2-2' }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
